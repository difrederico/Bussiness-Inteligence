name: Build APK - Ultra Conservador
on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Build completamente limpo'
        required: false
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-18.04  # Sistema MUITO antigo para máxima compatibilidade
    timeout-minutes: 120
    
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v3  # Versão mais antiga compatível
      with:
        fetch-depth: 1
    
    - name: 🐍 Python 3.7 (Ultra compatível)
      uses: actions/setup-python@v4
      with:
        python-version: '3.7.17'  # Python muito antigo
    
    - name: ☕ Java 8
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y openjdk-8-jdk
        export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
        echo "JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64" >> $GITHUB_ENV
    
    - name: 📦 Dependencies Ultra Antigas
      run: |
        sudo apt-get install -y \
          git zip unzip wget curl \
          build-essential autoconf libtool \
          pkg-config zlib1g-dev libffi-dev \
          libssl-dev python3-dev
    
    - name: 🐍 Python Stack Antigo
      run: |
        python3 -m pip install --upgrade pip==20.3.4
        pip install setuptools==50.3.2
        pip install wheel==0.35.1
        pip install cython==0.29.21
        pip install buildozer==1.2.0  # Versão MUITO antiga
        
        echo "=== VERSÕES ==="
        python3 --version
        buildozer --version
    
    - name: 📋 Config Ultra Simples
      run: |
        cat > buildozer.spec << 'EOF'
        [app]
        title = Leitor QR
        package.name = leitorqr
        package.domain = com.business
        source.main = main.py
        source.dir = .
        version = 1.0
        
        # SÓ O BÁSICO DOS BÁSICOS
        requirements = python3,kivy==1.11.1
        
        # ANDROID ANTIGO
        android.minapi = 16
        android.api = 27
        android.ndk = 17c
        
        orientation = portrait
        android.permissions = INTERNET,CAMERA
        android.archs = armeabi-v7a
        
        [buildozer]
        log_level = 2
        EOF
        
        cat buildozer.spec
    
    - name: 🧹 Limpar Tudo
      run: |
        rm -rf .buildozer bin dist
        find . -name "*.pyc" -delete
    
    - name: 🔨 Build Ultra Simples
      timeout-minutes: 90
      run: |
        export JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
        export GRADLE_OPTS="-Xmx512m"
        
        # Uma única tentativa com timeout agressivo
        timeout 5400s bash -c 'yes | buildozer android debug --verbose' || {
          echo "❌ Build falhou"
          find .buildozer -name "*.log" -exec echo "=== {} ===" \; -exec tail -50 {} \; 2>/dev/null || true
          exit 1
        }
    
    - name: 📦 Empacotar APK
      run: |
        APK=$(find . -name "*.apk" | head -1)
        if [ -n "$APK" ]; then
          mkdir -p dist
          cp "$APK" "dist/app-ultra-simples.apk"
          ls -lh dist/
        else
          echo "❌ Sem APK"
          exit 1
        fi
    
    - name: 📤 Upload
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: apk-ultra-conservador
        path: dist/*.apk