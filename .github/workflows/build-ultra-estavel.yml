name: Build Android APK - Ultra EstÃ¡vel
on:
  workflow_dispatch:
    inputs:
      use_stable_config:
        description: 'Use configuraÃ§Ã£o ultra-estÃ¡vel'
        required: false
        default: true
        type: boolean

jobs:
  build:
    runs-on: ubuntu-22.04  # VersÃ£o especÃ­fica e estÃ¡vel
    timeout-minutes: 90    # Tempo generoso para evitar timeouts
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: ğŸ§¹ Free Disk Space (Previne "No space left")
      run: |
        echo "=== EspaÃ§o inicial ==="
        df -h
        
        # Remove ferramentas desnecessÃ¡rias
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf /usr/local/lib/android/sdk/ndk
        sudo rm -rf /usr/local/.ghcup
        
        echo "=== EspaÃ§o apÃ³s limpeza ==="
        df -h
    
    - name: ğŸ Setup Python 3.10 (VersÃ£o testada)
      uses: actions/setup-python@v5
      with:
        python-version: '3.10.12'  # VersÃ£o especÃ­fica estÃ¡vel
        cache: 'pip'
    
    - name: â˜• Setup Java 17 (LTS)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'
    
    - name: ğŸ“¦ Install System Dependencies (CompatÃ­vel Ubuntu 22.04)
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          git zip unzip wget \
          build-essential \
          autoconf libtool \
          pkg-config \
          zlib1g-dev \
          libffi-dev \
          libssl-dev \
          python3-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo6 \
          libreadline8 \
          libsqlite3-dev \
          libbz2-dev \
          tk-dev \
          libgdbm-dev \
          libnss3-dev \
          libssl-dev \
          libreadline-dev \
          libffi-dev \
          curl \
          llvm \
          xz-utils
        
        # VerificaÃ§Ãµes essenciais
        python3 --version
        java -version
        which git
    
    - name: ğŸ”§ Setup Environment Variables
      run: |
        echo "JAVA_HOME=/opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17*/x64" >> $GITHUB_ENV
        echo "ANDROID_HOME=/opt/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=/opt/android-sdk" >> $GITHUB_ENV
        echo "PATH=$PATH:/opt/android-sdk/tools:/opt/android-sdk/platform-tools" >> $GITHUB_ENV
    
    - name: ğŸ Install Python Dependencies (VersÃµes especÃ­ficas)
      run: |
        python3 -m pip install --upgrade pip==24.0
        pip install setuptools==69.5.1 wheel==0.43.0
        pip install cython==3.0.10
        pip install buildozer==1.5.0
        
        # VerificaÃ§Ã£o das instalaÃ§Ãµes
        pip list | grep -E "(buildozer|cython)"
        buildozer --version
    
    - name: ğŸ“‹ Prepare Stable Configuration
      run: |
        cd v2-android
        
        # Backup da configuraÃ§Ã£o original
        cp buildozer.spec buildozer.spec.original
        
        # Use configuraÃ§Ã£o ultra-estÃ¡vel se solicitado
        if [ "${{ inputs.use_stable_config }}" = "true" ]; then
          echo "ğŸ”§ Usando configuraÃ§Ã£o ultra-estÃ¡vel..."
          cp buildozer_stable.spec buildozer.spec
        fi
        
        # Mostra configuraÃ§Ã£o que serÃ¡ usada
        echo "=== CONFIGURAÃ‡ÃƒO BUILDOZER ==="
        head -30 buildozer.spec
        echo "..."
        echo "=== REQUIREMENTS ==="
        grep "requirements.*=" buildozer.spec
    
    - name: ğŸ§¼ Clean Previous Builds
      run: |
        cd v2-android
        rm -rf .buildozer/android/platform/build-*
        rm -rf bin/
        rm -rf dist/
        
        # Limpa cache pip tambÃ©m
        pip cache purge
    
    - name: ğŸ”¨ Build APK (Com retry e timeout individual)
      timeout-minutes: 75
      run: |
        cd v2-android
        
        # ConfiguraÃ§Ãµes para buildozer
        export BUILDOZER_AUTO_ACCEPT_ANDROID_SDK_LICENSE=1
        export ANDROIDSDK=/opt/android-sdk
        export ANDROIDNDK=/opt/android-ndk
        export JAVA_OPTS="-Xmx4g"
        
        # Primeira tentativa (mÃ©todo padrÃ£o)
        echo "ğŸš€ Primeira tentativa de build..."
        if timeout 3600s bash -c 'yes | buildozer android debug'; then
          echo "âœ… Build bem-sucedido na primeira tentativa!"
        else
          echo "âš ï¸ Primeira tentativa falhou, tentando com configuraÃ§Ã£o reduzida..."
          
          # Segunda tentativa com configuraÃ§Ã£o mÃ­nima
          sed -i 's/requirements = .*/requirements = python3,kivy,pillow,pyjnius,android/' buildozer.spec
          sed -i 's/android.archs = .*/android.archs = arm64-v8a/' buildozer.spec
          
          echo "ğŸ”„ Segunda tentativa com requirements mÃ­nimos..."
          if timeout 3600s bash -c 'yes | buildozer android debug'; then
            echo "âœ… Build bem-sucedido na segunda tentativa!"
          else
            echo "âŒ Build falhou em ambas tentativas"
            exit 1
          fi
        fi
    
    - name: ğŸ” Locate and Verify APK
      run: |
        cd v2-android
        
        echo "=== Procurando APK ==="
        find . -name "*.apk" -type f
        
        # Cria diretÃ³rio de distribuiÃ§Ã£o
        mkdir -p dist
        
        # Encontra e copia APK
        APK_FILE=$(find . -name "*.apk" -type f | head -1)
        if [ -n "$APK_FILE" ]; then
          echo "âœ… APK encontrado: $APK_FILE"
          
          # Copia com nome limpo
          cp "$APK_FILE" dist/MercadoEmNumeros-v2.1-$(date +%Y%m%d).apk
          
          # InformaÃ§Ãµes do APK
          ls -lh dist/
          file dist/*.apk
          
          echo "ğŸ‰ APK pronto para download!"
        else
          echo "âŒ Nenhum APK encontrado!"
          
          # Debug: mostra estrutura de diretÃ³rios
          echo "=== Estrutura de diretÃ³rios ==="
          find .buildozer -type d -name "*dist*" || true
          find . -name "build.gradle" || true
          
          exit 1
        fi
    
    - name: ğŸ“¤ Upload APK Success
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-estavel-${{ github.run_number }}
        path: v2-android/dist/*.apk
        retention-days: 30
        if-no-files-found: error
    
    - name: ğŸ“¤ Upload Debug Logs (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-debug-${{ github.run_number }}
        path: |
          v2-android/.buildozer/**/*.log
          v2-android/buildozer.spec
        retention-days: 14
        if-no-files-found: warn
    
    - name: ğŸ“Š Build Summary
      if: always()
      run: |
        cd v2-android
        echo "=== RESUMO DO BUILD ==="
        echo "ğŸ“ Arquivos APK:"
        find . -name "*.apk" -type f | wc -l
        echo "ğŸ’¾ EspaÃ§o usado:"
        du -sh .buildozer/ || echo "DiretÃ³rio .buildozer nÃ£o encontrado"
        echo "ğŸ• Fim do build: $(date)"